\section{РАЗРАБОТКА ПРОГРАММНЫХ МОДУЛЕЙ}
\label{sec:dev}

В разделе разработки программных модулей
описана разработка ключевых алгоритмов для данного дипломного проекта.

\subsection{Алгоритм калибровки магнетометра}

Описываемый алгоритм отвечает за калибровку магнетометра и описывает полный цикл работы модуля калибровки магнитометра: от инициализации и вычитки параметров до
вычисления калибровки и уточнения данных. 

Распишем данный алгоритм по шагам:
\begin{enumerate_step}
    \item Начало алгоритма.
    \item Проверка дескриптора, что он не равен невалидному адресу \lstinline|BL_CALIB_INVALID_HANDLE|, если равен, то выйти с ошибкой
    \lstinline|BL_CALIB_ERROR_INVALID_HANDLE|.
    \item Создание массива \lstinline|calibrateData| для хранения откалиброванных данных.
    \item Создание массива \lstinline|hardIronCalibrate| для хранения калибровочных параметров.
    \item Создание массива \lstinline|hardIronCalibrate| для хранения жестких смещений магнитного поля.
    \item Запуск потока вызовом \lstinline|PT_BEGIN|.
    \item \label{i:alg:mag:965} Проверка существует ли запрос на чтение параметров из флэш памяти. Если поле \lstinline|readParametersRequest| дескриптора равно \lstinline|CALIB_REQUEST_FOR_PARAMETERS|,
    то перейти к шагу \ref{i:alg:mag:967}, иначе перейти к следующему шагу.
    \item \label{i:alg:mag:974} Если текущее поле \lstinline|command| дескриптора равно \lstinline|CALIB_APPLY|, то перейти дальше, иначе перейти к шагу
    \ref{i:alg:mag:997}.
    \item Проверить поле структуры обратного вызова дескриптора \lstinline|magnetoCb.magnetoWasRead|, на то были ли получены новые данные от драйвера магнетометра, 
    если нет то переключить контекст на другие потоки, иначе выполнить следующий шаг.
    \item Снять флаг \lstinline|magnetoCb.magnetoWasRead|.
    \item Проверить была ли ошибка при получении данных от драйвера магнитометра. Если ошибка была то перейти к следующему шагу, иначе перейти к шагу \ref{i:alg:mag:986}.
    \item В случае ошибки вызвать обратный вызов с кодом ошибки \lstinline|BL_CALIB_MANAGER_ERROR_MAGNETOMETER| и данными равными \lstinline|NULL|,
    который хранится в поле обратного вызова \lstinline|cbParams.cbWithData| дескриптора.
    \item \label{i:alg:mag:986} Вычесть вектор смещений \lstinline|hardIronOffsets| по трем осям из прочитанного вектора \lstinline|data|.
    \item \label{i:alg:mag:991} Перемножить матрицу \lstinline|softIronScales|, хранящую мягкие смещения магнетометра вместе с вектором полученном на шаге \ref{i:alg:mag:986}
    \item Вызвать пользовательскую функцию \lstinline|cbParams.cbWithData| со статусом \lstinline|BL_CALIB_MANAGER_OK| и данными полученным на шаге \ref{i:alg:mag:991}
    \item \label{i:alg:mag:997} Если текущее поле \lstinline|command| дескриптора равно \lstinline|CALIB_RECALIBRATE_CANCEL|, то перейти дальше, иначе перейти к шагу
    \ref{i:alg:mag:1004}.
    \item Установить в поле \lstinline|command| дескриптора команду \lstinline|CALIB_APPLY|.
    \item Установить в поле \lstinline|measurementCount| дескриптора значение 0.
    \item Вызвать функцию пользователя \lstinline|cbWithData| со статусом \lstinline|BL_CALIB_MANAGER_OK|.
    \item \label{i:alg:mag:1004} Если текущее поле \lstinline|command| дескриптора равно \lstinline|CALIB_RECALIBRATE|, то перейти дальше, иначе перейти к шагу
    \ref{i:alg:mag:1008}.
    \item \label{i:alg:mag:810} Проверить, что поле \lstinline|command| дескриптора не равно \lstinline|CALIB_RECALIBRATE_CANCEL|, если условие истинно, то перейти к следующему шагу, иначе
    перейти к шагу \ref{i:alg:mag:965}.
    \item Проверить, что \lstinline|measurementCount| меньше \lstinline|CALIB_MEAS_NUM|, если условие истинно, то перейти дальше, иначе перейти к шагу \ref{i:alg:mag:830}.
    \item Проверить поле структуры обратного вызова дескриптора \lstinline|magnetoCb.magnetoWasRead|, на то были ли получены новые данные от драйвера магнетометра, 
    если нет, то переключить контекст на другие потоки, иначе выполнить следующий шаг.
    \item Снять флаг \lstinline|magnetoCb.magnetoWasRead|.
    \item Сохранить полученные данные в буфер \lstinline|calib_dataStorage|.
    \item Увеличить счетчик measurementCount на единицу.
    \item Перейти к шагу \ref{i:alg:mag:810}.
    \item \label{i:alg:mag:830} Проинициализировать значения \lstinline|magnetColl| для этого необходимо для каждого вектора из буфера \lstinline|calib_dataStorage| найти его сонаправленный.
    \item \label{i:alg:mag:FindL} Найти промежуточные параметры \lstinline|L|, используя формулу \ref{eq:domain:findL}.
    \item Найти \lstinline|magnetCollUpdated|, используя формулу \ref{eq:domain:updateMk}.
    \item Найти сонаправленный вектор для \lstinline|magnetCollUpdated| и записать его в \lstinline|magnetColl|.
    \item Записать значение \lstinline|calcErr|, используя формулу \ref{eq:domain:findError}.
    \item Сравнить значение с \lstinline|CALIB_MIN_CALC_ERROR|, если значение меньше, то перейти дальше, иначе перейти к шагу \ref{i:alg:mag:FindL}.
    \item Записать значения от 0-8 вектора \lstinline|L| в матрицу \lstinline|softIronScales|.
    \item Записать значения от 9-11 вектора \lstinline|L| в матрицу \lstinline|hardIronScales|.
    \item Вычислить CRC-код параметров \lstinline|hardIronScales| и \lstinline|softIronScales|, записанных в одну структуру \lstinline|calibParams|.
    \item Проверить валидность вычисленного кода, если код не равен \lstinline|BL_CRC_INVALID|, то перейти дальше, иначе перейти к шагу \ref{i:alg:mag:846}.
    \item Записать в структуру \lstinline|calibParams| в поле \lstinline|checkSum| вычисленный код.
    \item Проверить выходное значение процедуры \lstinline|businessLayer_flashReadyToOperate|, если значение истинно то перейти дальше, иначе переключить контекст.
    \item Сбросить флаг состояния обратного вызова флэш памяти \lstinline|flashCb.flashIsReady|.
    \item Вызвать процедуру \lstinline|businessLayer_flashWriteAsync|, с данными \lstinline|calibParams| и адресом \lstinline|parametersAddress| из структуры дескриптора.
    \item Проверить состояние обратного вызова флэш памяти \lstinline|flashCb.flashIsReady|, если значение истинно то перейти дальше, иначе переключить контекст.
    \item \label{i:alg:mag:846} Присвоить полю \lstinline|command| дескриптора \lstinline|CALIB_CANCEL|.
    \item Вызвать пользовательскую функцию \lstinline|cbWithoutData| с состоянием \lstinline|CALIB_WARNING_INVALID_CHECKSUM|.
    \item \label{i:alg:mag:1008} Если текущее поле \lstinline|command| дескриптора равно \lstinline|CALIB_RESET_TO_DEFAULTS|, то перейти дальше, иначе перейти к шагу
    \ref{i:alg:mag:965}.
    \item Присвоить полю \lstinline|command| дескриптора \lstinline|CALIB_APPLY|.
    \item Скопировать матрицу \lstinline|calib_softIronDef| в матрицу \lstinline|softIronScales|.
    \item Скопировать матрицу \lstinline|calib_hardIronDef| в матрицу \lstinline|hardIronScales|.
    \item Вычислить CRC-код параметров \lstinline|hardIronScales| и \lstinline|softIronScales|, записанных в одну структуру \lstinline|calibParams|.
    \item Проверить валидность вычисленного кода, если код не равен \lstinline|BL_CRC_INVALID|, то перейти дальше, иначе перейти к шагу \ref{i:alg:mag:759}.
    \item Записать в структуру \lstinline|calibParams| в поле \lstinline|checkSum| вычисленный код.
    \item Проверить выходное значение процедуры \lstinline|businessLayer_flashReadyToOperate|, если значение истинно то перейти дальше, иначе переключить контекст.
    \item Сбросить флаг состояния обратного вызова флэш памяти \lstinline|flashCb.flashIsReady|.
    \item Вызвать пользовательскую функцию \lstinline|cbWithoutData| с состоянием \lstinline|BL_CALIB_MANAGER_OK|.
    \item \label{i:alg:mag:759} Вызвать пользовательскую функцию \lstinline|cbWithoutData| с состоянием \lstinline|CALIB_WARNING_INVALID_CHECKSUM|.
    \item Перезапустить поток.
    \item Вызвать процедуру \lstinline|businessLayer_flashWriteAsync|, с данными \lstinline|calibParams| и адресом \lstinline|parametersAddress| из структуры дескриптора.
    \item Проверить состояние обратного вызова флэш памяти \lstinline|flashCb.flashIsReady|, если значение истинно то перейти дальше, иначе переключить контекст.
    \item \label{i:alg:mag:967} Если текущее поле \lstinline|readParametersRequest| дескриптора равно \lstinline|CALIB_REQUEST_FOR_PARAMETERS|, то перейти дальше, иначе перейти к шагу
    \ref{i:alg:mag:965}. 
    \item Проверить выходное значение процедуры \lstinline|businessLayer_flashReadyToOperate|, если значение истинно то перейти дальше, иначе переключить контекст.
    \item Сбросить флаг состояния обратного вызова флэш памяти \lstinline|flashCb.flashIsReady|.
    \item Вызвать процедуру чтения флэш памяти \lstinline|businessLayer_flashReadAsync|, с переданным параметром \lstinline|calibParams| и размером данных, и присвоить выходное значение функции переменной \lstinline|flashRetCode|.
    \item Если текущее значение \lstinline|flashRetCode| не равно \lstinline|BL_FLASH_RETURN_CODE_OK|, то перейти дальше, иначе перейти к шагу
    \ref{i:alg:mag:899}.
    \item Проверить состояние обратного вызова флэш памяти \lstinline|flashCb.flashIsReady|, если значение истинно то перейти дальше, иначе переключить контекст.
    \item Проверить состояние ошибок обратного вызова флэш памяти \lstinline|flashCb.error|, если значение истинно то перейти дальше, иначе перейти к шагу \ref{i:alg:mag:899}.
    \item Присвоить полю \lstinline|readParametersRequest| дескриптора значение \lstinline|CALIB_PARAMETERS_WAS_READ_SUCCESS|.
    \item Вычислить CRC-код прочитанных данных.
    \item Сравнить прочитанный CRC-код с вычисленным. Если условие истинно перейти к шагу \ref{i:alg:mag:974}, иначе перейти к шагу \ref{i:alg:mag:899}.
    \item \label{i:alg:mag:899} Установить поле \lstinline|readParametersRequest| дескриптора равным \lstinline|CALIBRATION_PARAMETERS_WAS_READ_FAIL|, и перейти к шагу \ref{i:alg:mag:971}.
    \item \label{i:alg:mag:971} \item Скопировать матрицу \lstinline|calib_softIronDef| в матрицу \lstinline|softIronScales|.
    \item Скопировать матрицу \lstinline|calib_hardIronDef| в матрицу \lstinline|hardIronScales|.
    \item Перейти к шагу \ref{i:alg:mag:974}.
\end{enumerate_step}

\subsection{Алгоритм калибровки акселерометра}

Описываемый алгоритм отвечает за калибровку акселерометра и описывает полный цикл работы модуля калибровки акселерометра: от инициализации и вычитки параметров до
вычисления калибровки и уточнения данных. 

Распишем данный алгоритм по шагам:
\begin{enumerate_step}
    \item Начало алгоритма.
    \item Проверка дескриптора, что он не равен невалидному адресу \lstinline|BL_CALIB_INVALID_HANDLE|, если равен, то выйти с ошибкой
    \lstinline|BL_CALIB_ERROR_INVALID_HANDLE|.
    \item Создание массива \lstinline|calibrateData| для хранения откалиброванных данных.
    \item Создание массива \lstinline|inputMeasurements| для хранения входных данных.
    \item 
\end{enumerate_step}


\subsection{Алгоритм калибровки гироскопа}

\subsection{Алгоритм расчета ориентации и азимута}

\subsection{Алгоритм управления калибровкой}
